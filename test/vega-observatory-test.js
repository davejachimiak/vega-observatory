// Generated by CoffeeScript 1.7.1
(function() {
  describe('VegaObservatory', function() {
    beforeEach(function() {
      var options;
      options = {
        url: 'ws://0.0.0.0:3000',
        roomId: '/abc123',
        badge: {}
      };
      this.vegaObservatory = new VegaObservatory(options);
      this.peerConnectionFactory = this.vegaObservatory.peerConnectionFactory;
      return this.vegaClient = this.vegaObservatory.vegaClient;
    });
    afterEach(function() {
      return sinon.collection.restore();
    });
    describe('#call', function() {
      return it('delegates to the vega client', function() {
        var call;
        call = sinon.collection.stub(this.vegaClient, 'call');
        this.vegaObservatory.call();
        return expect(call).to.have.been.called;
      });
    });
    return describe('callbacks', function() {
      beforeEach(function() {
        return sinon.collection.stub(this.peerConnectionFactory, 'create').returns(this.peerConnection = 'a peer connection!');
      });
      describe('on callAccepted', function() {
        beforeEach(function() {
          this.peer1 = {
            peerId: 'peerId1',
            badge: {
              name: 'Dave'
            }
          };
          this.peer2 = {
            peerId: 'peerId2',
            badge: {
              name: 'Allie'
            }
          };
          return this.peers = [this.peer1, this.peer2];
        });
        it('saves references to all peers in the response', function() {
          this.vegaClient.trigger('callAccepted', this.peers);
          return expect(this.vegaObservatory.peerStore).to.eql({
            "peerId1": {
              badge: this.peer1.badge,
              peerConnection: this.peerConnection
            },
            "peerId2": {
              badge: this.peer2.badge,
              peerConnection: this.peerConnection
            }
          });
        });
        return it('triggers a callAccepted event on the observatory', function() {
          var object;
          object = {};
          this.vegaObservatory.on('callAccepted', function(payload) {
            return object.peers = payload;
          });
          this.vegaClient.trigger('callAccepted', this.peers);
          return expect(object.peers).to.eq(this.peers);
        });
      });
      return describe('on offer', function() {
        beforeEach(function() {
          this.badge = {
            name: 'Dave'
          };
          return this.payload = {
            peerId: 'peerId',
            badge: this.badge,
            offer: {
              'offer key': 'offer value'
            }
          };
        });
        it('saves a reference to the peer', function() {
          this.vegaClient.trigger('offer', this.payload);
          return expect(this.vegaObservatory.peerStore).to.eql({
            "peerId": {
              badge: this.badge,
              peerConnection: this.peerConnection
            }
          });
        });
        return it('triggers an offer event', function() {
          var object;
          object = {};
          this.vegaObservatory.on('offer', function(payload) {
            return object.payload = payload;
          });
          this.vegaClient.trigger('offer', this.payload);
          return expect(object.payload).to.eq(this.payload);
        });
      });
    });
  });

}).call(this);
